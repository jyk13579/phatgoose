#!/bin/bash
# p3
# 'P/RETRIEVE/Retriever.datasets=["D/P3SOCIALIQA/TRAIN", "D/P3PAWS/TRAIN", "D/P3WIKIQA/TRAIN", "D/P3ROPES/TRAIN", "D/P3AGNEWS/TRAIN", "D/P3AMAZONPOLARITY/TRAIN", "D/P3WIKIBIO/TRAIN", "D/P3CNNDAILYMAIL/TRAIN", "D/P3COSMOSQA/TRAIN", "D/P3QUAIL/TRAIN", "D/P3QUARTZ/TRAIN", "D/P3QASC/TRAIN", "D/P3COMMONGEN/TRAIN", "D/P3ADVERSARIALQA/TRAIN", "D/P3APPREVIEWS/TRAIN", "D/P3COMMONSENSEQA/TRAIN", "D/P3COSE/TRAIN", "D/P3DBPEDIA14/TRAIN", "D/P3DREAM/TRAIN", "D/P3DUORC/TRAIN", "D/P3GIGAWORD/TRAIN", "D/P3HOTPOTQA/TRAIN", "D/P3IMDB/TRAIN", "D/P3MRPC/TRAIN", "D/P3MULTINEWS/TRAIN", "D/P3QQP/TRAIN", "D/P3QUAREL/TRAIN", "D/P3QUOREF/TRAIN", "D/P3ROTTENTOMATOES/TRAIN", "D/P3SAMSUM/TRAIN", "D/P3SCIQ/TRAIN", "D/P3TREC/TRAIN", "D/P3WIKIHOP/TRAIN", "D/P3WIQA/TRAIN", "D/P3XSUM/TRAIN", "D/P3YELP/TRAIN"]'
# flanv2
# 'P/RETRIEVE/Retriever.datasets=["D/FLAN2021AI2ARCEASY/ZS/TRAIN", "D/FLAN2021AI2ARCCHALLENGE/ZS/TRAIN", "D/FLAN2021ALGEBRALINEAR1D/ZS/TRAIN", "D/FLAN2021BOOLQ/ZS/TRAIN", "D/FLAN2021COQA/ZS/TRAIN", "D/FLAN2021DEFPRONOUNRESOLUTION/ZS/TRAIN", "D/FLAN2021DROP/ZS/TRAIN", "D/FLAN2021FIXPUNCT/ZS/TRAIN", "D/FLAN2021GEMDART/ZS/TRAIN", "D/FLAN2021GEME2ENLG/ZS/TRAIN", "D/FLAN2021GEMWEBNLGEN/ZS/TRAIN", "D/FLAN2021GEMWIKILINGUAEN/ZS/TRAIN", "D/FLAN2021GLUESST2/ZS/TRAIN", "D/FLAN2021GLUECOLA/ZS/TRAIN", "D/FLAN2021GLUEMNLI/ZS/TRAIN", "D/FLAN2021GLUEQNLI/ZS/TRAIN", "D/FLAN2021GLUESTSB/ZS/TRAIN", "D/FLAN2021GLUEWNLI/ZS/TRAIN", "D/FLAN2021LAMBADA/ZS/TRAIN", "D/FLAN2021NATURALQUESTIONSOPEN/ZS/TRAIN", "D/FLAN2021NEWSROOM/ZS/TRAIN", "D/FLAN2021OPENBOOKQA/ZS/TRAIN", "D/FLAN2021OPINIONABSTRACTSIDEBATE/ZS/TRAIN", "D/FLAN2021OPINIONABSTRACTSROTTENTOMATOES/ZS/TRAIN", "D/FLAN2021PARACRAWLENES/ZS/TRAIN", "D/FLAN2021PIQA/ZS/TRAIN", "D/FLAN2021QUAC/ZS/TRAIN", "D/FLAN2021SENTIMENT140/ZS/TRAIN", "D/FLAN2021SNLI/ZS/TRAIN", "D/FLAN2021SQUAD/ZS/TRAIN", "D/FLAN2021SUPERGLUEMULTIRC/ZS/TRAIN", "D/FLAN2021SUPERGLUERECORD/ZS/TRAIN", "D/FLAN2021TRIVIAQA/ZS/TRAIN", "D/FLAN2021TRUECASE/ZS/TRAIN", "D/FLAN2021UNIFIEDQASCIENCEINST/ZS/TRAIN", "D/FLAN2021WORDSEGMENT/ZS/TRAIN"]'
# niv2
# 'P/RETRIEVE/Retriever.datasets=["D/NIV2TRANSLATION/ZS/TRAIN", "D/NIV2PROGRAMEXECUTION/ZS/TRAIN", "D/NIV2QUESTIONGENERATION/ZS/TRAIN", "D/NIV2SENTIMENTANALYSIS/ZS/TRAIN", "D/NIV2TEXTCATEGORIZATION/ZS/TRAIN", "D/NIV2TEXTMATCHING/ZS/TRAIN", "D/NIV2TOXICLANGUAGEDETECTION/ZS/TRAIN", "D/NIV2CAUSEEFFECTCLASSIFICATION/ZS/TRAIN", "D/NIV2INFORMATIONEXTRACTION/ZS/TRAIN", "D/NIV2TEXTUALENTAILMENT/ZS/TRAIN", "D/NIV2WRONGCANDIDATEGENERATION/ZS/TRAIN", "D/NIV2NAMEDENTITYRECOGNITION/ZS/TRAIN", "D/NIV2COMMONSENSECLASSIFICATION/ZS/TRAIN", "D/NIV2FILLINTHEBLANK/ZS/TRAIN", "D/NIV2TEXTCOMPLETION/ZS/TRAIN", "D/NIV2SENTENCECOMPOSITION/ZS/TRAIN", "D/NIV2TITLEGENERATION/ZS/TRAIN", "D/NIV2LANGUAGEIDENTIFICATION/ZS/TRAIN", "D/NIV2QUESTIONUNDERSTANDING/ZS/TRAIN", "D/NIV2SENTENCEPERTURBATION/ZS/TRAIN", "D/NIV2ANSWERABILITYCLASSIFICATION/ZS/TRAIN", "D/NIV2SUMMARIZATION/ZS/TRAIN", "D/NIV2COREFERENCERESOLUTION/ZS/TRAIN", "D/NIV2TEXTQUALITYEVALUATION/ZS/TRAIN", "D/NIV2TEXTTOCODE/ZS/TRAIN", "D/NIV2PARAPHRASING/ZS/TRAIN", "D/NIV2DIALOGUEGENERATION/ZS/TRAIN", "D/NIV2QUESTIONREWRITING/ZS/TRAIN", "D/NIV2WORDSEMANTICS/ZS/TRAIN", "D/NIV2POSTAGGING/ZS/TRAIN", "D/NIV2LINGUISTICPROBING/ZS/TRAIN", "D/NIV2STORYCOMPOSITION/ZS/TRAIN", "D/NIV2SPEAKERIDENTIFICATION/ZS/TRAIN", "D/NIV2WORDANALOGY/ZS/TRAIN", "D/NIV2DATATOTEXT/ZS/TRAIN", "D/NIV2STEREOTYPEDETECTION/ZS/TRAIN", "D/NIV2NEGOTIATIONSTRATEGYDETECTION/ZS/TRAIN", "D/NIV2DIALOGUEACTRECOGNITION/ZS/TRAIN", "D/NIV2GENDERCLASSIFICATION/ZS/TRAIN", "D/NIV2COHERENCECLASSIFICATION/ZS/TRAIN", "D/NIV2EXPLANATION/ZS/TRAIN", "D/NIV2ETHICSCLASSIFICATION/ZS/TRAIN", "D/NIV2WORDRELATIONCLASSIFICATION/ZS/TRAIN", "D/NIV2SENTENCEORDERING/ZS/TRAIN", "D/NIV2ANSWERVERIFICATION/ZS/TRAIN", "D/NIV2MATHEMATICS/ZS/TRAIN", "D/NIV2INTENTIDENTIFICATION/ZS/TRAIN", "D/NIV2KEYWORDTAGGING/ZS/TRAIN", "D/NIV2CODETOTEXT/ZS/TRAIN", "D/NIV2DIALOGUESTATETRACKING/ZS/TRAIN", "D/NIV2TEXTSIMPLIFICATION/ZS/TRAIN", "D/NIV2STANCEDETECTION/ZS/TRAIN", "D/NIV2FACTVERIFICATION/ZS/TRAIN", "D/NIV2GRAMMARERRORDETECTION/ZS/TRAIN", "D/NIV2SECTIONCLASSIFICATION/ZS/TRAIN", "D/NIV2NUMBERCONVERSION/ZS/TRAIN", "D/NIV2STYLETRANSFER/ZS/TRAIN", "D/NIV2SPEAKERRELATIONCLASSIFICATION/ZS/TRAIN", "D/NIV2IRONYDETECTION/ZS/TRAIN", "D/NIV2QUESTIONDECOMPOSITION/ZS/TRAIN", "D/NIV2OVERLAPEXTRACTION/ZS/TRAIN", "D/NIV2GRAMMARERRORCORRECTION/ZS/TRAIN", "D/NIV2SPELLINGERRORDETECTION/ZS/TRAIN", "D/NIV2ENTITYGENERATION/ZS/TRAIN", "D/NIV2SENTENCEEXPANSION/ZS/TRAIN", "D/NIV2DISCOURSECONNECTIVEIDENTIFICATION/ZS/TRAIN", "D/NIV2DISCOURSERELATIONCLASSIFICATION/ZS/TRAIN", "D/NIV2POEMGENERATION/ZS/TRAIN", "D/NIV2ENTITYRELATIONCLASSIFICATION/ZS/TRAIN", "D/NIV2PUNCTUATIONERRORDETECTION/ZS/TRAIN", "D/NIV2SPAMCLASSIFICATION/ZS/TRAIN", "D/NIV2PAPERREVIEW/ZS/TRAIN", "D/NIV2SENTENCECOMPRESSION/ZS/TRAIN", "D/NIV2PREPOSITIONPREDICTION/ZS/TRAIN", "D/NIV2MISC/ZS/TRAIN"]'
# add1
# 'P/RETRIEVE/Retriever.datasets=["D/P3WSCFIXED/TRAIN", "D/P3COPA/TRAIN", "D/P3HSWAG/TRAIN", "D/P3WIC/TRAIN", "D/P3RACEHIGH/TRAIN", "D/P3RACEMIDDLE/TRAIN", "D/P3WEBQUESTIONS/TRAIN", "D/DIALOGQRECC/ZS/TRAIN", "D/DIALOGWIKIDIALOG/ZS/TRAIN", "D/DIALOGQRECCII/ZS/TRAIN", "D/DIALOGWIKIDIALOGII/ZS/TRAIN", "D/FLAN2021AESLC/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATECSEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATEDEEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATERUEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATEFIEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATEROEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATETREN/ZS/TRAIN", "D/FLAN2021WMT14TRANSLATEFREN/ZS/TRAIN"]'
# Default values
SCORE_TYPE=original
SCALING_SCORES=True
ELEMENTWISE_AFFINE=False
ARCH=A2
MAKE_EXPERT_LIBRARY=False
CREATE_CHECKPOINT=False
MODEL_TYPE=t5xl
INCLUDE_ANSWER_CHOICES=True
DATASET_SETTING=All
# Parse command-line arguments
while [[ $# -gt 0 ]]; do
  key="$1"

  case $key in
    -score_type)
      SCORE_TYPE="$2"
      shift
      ;;
    -scaling_scores)
      SCALING_SCORES="$2"
      shift
      ;;
    -elementwise_affine)
      ELEMENTWISE_AFFINE="$2"
      shift
      ;;
    -arch)
      ARCH="$2"
      shift
      ;;
    -exp_name)
      EXP_NAME="$2"
      shift
      ;;
    -make_expert_library)
      MAKE_EXPERT_LIBRARY="$2"
      shift
      ;;
    -create_checkpoint)
        CREATE_CHECKPOINT="$2"
        shift
        ;;
    -model_type)
      MODEL_TYPE="$2"
      shift
      ;;
    -include_answer_choices)
        INCLUDE_ANSWER_CHOICES="$2"
        shift
        ;;
    -dataset_setting)
        DATASET_SETTING="$2"
        shift
        ;;
    -extra_bindings)
      EXTRA_BINDINGS="$2"
      shift
      ;;
    *)
      # Unknown option, ignore
      ;;
  esac

  shift
done

if [[ "$ARCH" == "A1" ]]; then
  echo -e "Using A1 architecture\n"
  ARCH_GIN=colm/models/${MODEL_TYPE}/moe_lora_rank16_a1.gin
elif [[ "$ARCH" == "A2" ]]; then
  echo -e "Using A2 architecture\n"
  ARCH_GIN=colm/models/${MODEL_TYPE}/moe_lora_rank16_a2.gin
else
  echo -e "Error: ARCH is not set to A1 or A2\n"
  exit 1
fi

if [[ "$INCLUDE_ANSWER_CHOICES" == "True" ]]; then
    echo -e "Including answer choices\n"
    ANSWER_CHOICES_BINDING='P/RETRIEVE/Retriever.include_answer_choices=True'
    EXP_LIB_DIR_BINDING='P/RETRIEVE/Retriever.expert_library_dir="exp_out/elm_1000_ans_minlm"'
    READ_DIR="elm_1000_ans_minlm"
else
    echo -e "Not including answer choices\n"
    ANSWER_CHOICES_BINDING='P/RETRIEVE/Retriever.include_answer_choices=False'
    EXP_LIB_DIR_BINDING='P/RETRIEVE/Retriever.expert_library_dir="exp_out/elm_1000_minlm"'
    READ_DIR="elm_1000_minlm"
fi

if [[ "$DATASET_SETTING" == "P3" ]]; then
    echo -e "Using P3 dataset setting\n"
    DATASET_BINDING='P/RETRIEVE/Retriever.datasets=["D/P3SOCIALIQA/TRAIN", "D/P3PAWS/TRAIN", "D/P3WIKIQA/TRAIN", "D/P3ROPES/TRAIN", "D/P3AGNEWS/TRAIN", "D/P3AMAZONPOLARITY/TRAIN", "D/P3WIKIBIO/TRAIN", "D/P3CNNDAILYMAIL/TRAIN", "D/P3COSMOSQA/TRAIN", "D/P3QUAIL/TRAIN", "D/P3QUARTZ/TRAIN", "D/P3QASC/TRAIN", "D/P3COMMONGEN/TRAIN", "D/P3ADVERSARIALQA/TRAIN", "D/P3APPREVIEWS/TRAIN", "D/P3COMMONSENSEQA/TRAIN", "D/P3COSE/TRAIN", "D/P3DBPEDIA14/TRAIN", "D/P3DREAM/TRAIN", "D/P3DUORC/TRAIN", "D/P3GIGAWORD/TRAIN", "D/P3HOTPOTQA/TRAIN", "D/P3IMDB/TRAIN", "D/P3MRPC/TRAIN", "D/P3MULTINEWS/TRAIN", "D/P3QQP/TRAIN", "D/P3QUAREL/TRAIN", "D/P3QUOREF/TRAIN", "D/P3ROTTENTOMATOES/TRAIN", "D/P3SAMSUM/TRAIN", "D/P3SCIQ/TRAIN", "D/P3TREC/TRAIN", "D/P3WIKIHOP/TRAIN", "D/P3WIQA/TRAIN", "D/P3XSUM/TRAIN", "D/P3YELP/TRAIN"]'
    FROM_CHECKPOINT_PATH="P3CompleteA2_t5xl_lora_concatenated"
    if [[ "$INCLUDE_ANSWER_CHOICES" == "True" ]]; then
        TO_CHECKPOINT_PATH="P3Completeansretrieval_t5xl_lora_concatenated"
    else
        TO_CHECKPOINT_PATH="P3Completeretrieval_t5xl_lora_concatenated"
    fi

elif [[ "$DATASET_SETTING" == "Flanv2" ]]; then
    echo -e "Using FLANv2 dataset setting\n"
    DATASET_BINDING='P/RETRIEVE/Retriever.datasets=["D/FLAN2021AI2ARCEASY/ZS/TRAIN", "D/FLAN2021AI2ARCCHALLENGE/ZS/TRAIN", "D/FLAN2021ALGEBRALINEAR1D/ZS/TRAIN", "D/FLAN2021BOOLQ/ZS/TRAIN", "D/FLAN2021COQA/ZS/TRAIN", "D/FLAN2021DEFPRONOUNRESOLUTION/ZS/TRAIN", "D/FLAN2021DROP/ZS/TRAIN", "D/FLAN2021FIXPUNCT/ZS/TRAIN", "D/FLAN2021GEMDART/ZS/TRAIN", "D/FLAN2021GEME2ENLG/ZS/TRAIN", "D/FLAN2021GEMWEBNLGEN/ZS/TRAIN", "D/FLAN2021GEMWIKILINGUAEN/ZS/TRAIN", "D/FLAN2021GLUESST2/ZS/TRAIN", "D/FLAN2021GLUECOLA/ZS/TRAIN", "D/FLAN2021GLUEMNLI/ZS/TRAIN", "D/FLAN2021GLUEQNLI/ZS/TRAIN", "D/FLAN2021GLUESTSB/ZS/TRAIN", "D/FLAN2021GLUEWNLI/ZS/TRAIN", "D/FLAN2021LAMBADA/ZS/TRAIN", "D/FLAN2021NATURALQUESTIONSOPEN/ZS/TRAIN", "D/FLAN2021NEWSROOM/ZS/TRAIN", "D/FLAN2021OPENBOOKQA/ZS/TRAIN", "D/FLAN2021OPINIONABSTRACTSIDEBATE/ZS/TRAIN", "D/FLAN2021OPINIONABSTRACTSROTTENTOMATOES/ZS/TRAIN", "D/FLAN2021PARACRAWLENES/ZS/TRAIN", "D/FLAN2021PIQA/ZS/TRAIN", "D/FLAN2021QUAC/ZS/TRAIN", "D/FLAN2021SENTIMENT140/ZS/TRAIN", "D/FLAN2021SNLI/ZS/TRAIN", "D/FLAN2021SQUAD/ZS/TRAIN", "D/FLAN2021SUPERGLUEMULTIRC/ZS/TRAIN", "D/FLAN2021SUPERGLUERECORD/ZS/TRAIN", "D/FLAN2021TRIVIAQA/ZS/TRAIN", "D/FLAN2021TRUECASE/ZS/TRAIN", "D/FLAN2021UNIFIEDQASCIENCEINST/ZS/TRAIN", "D/FLAN2021WORDSEGMENT/ZS/TRAIN"]'

elif [[ "$DATASET_SETTING" == "Niv2" ]]; then
    echo -e "Using Niv2 dataset setting\n"
    DATASET_BINDING='P/RETRIEVE/Retriever.datasets=["D/NIV2TRANSLATION/ZS/TRAIN", "D/NIV2PROGRAMEXECUTION/ZS/TRAIN", "D/NIV2QUESTIONGENERATION/ZS/TRAIN", "D/NIV2SENTIMENTANALYSIS/ZS/TRAIN", "D/NIV2TEXTCATEGORIZATION/ZS/TRAIN", "D/NIV2TEXTMATCHING/ZS/TRAIN", "D/NIV2TOXICLANGUAGEDETECTION/ZS/TRAIN", "D/NIV2CAUSEEFFECTCLASSIFICATION/ZS/TRAIN", "D/NIV2INFORMATIONEXTRACTION/ZS/TRAIN", "D/NIV2TEXTUALENTAILMENT/ZS/TRAIN", "D/NIV2WRONGCANDIDATEGENERATION/ZS/TRAIN", "D/NIV2NAMEDENTITYRECOGNITION/ZS/TRAIN", "D/NIV2COMMONSENSECLASSIFICATION/ZS/TRAIN", "D/NIV2FILLINTHEBLANK/ZS/TRAIN", "D/NIV2TEXTCOMPLETION/ZS/TRAIN", "D/NIV2SENTENCECOMPOSITION/ZS/TRAIN", "D/NIV2TITLEGENERATION/ZS/TRAIN", "D/NIV2LANGUAGEIDENTIFICATION/ZS/TRAIN", "D/NIV2QUESTIONUNDERSTANDING/ZS/TRAIN", "D/NIV2SENTENCEPERTURBATION/ZS/TRAIN", "D/NIV2ANSWERABILITYCLASSIFICATION/ZS/TRAIN", "D/NIV2SUMMARIZATION/ZS/TRAIN", "D/NIV2COREFERENCERESOLUTION/ZS/TRAIN", "D/NIV2TEXTQUALITYEVALUATION/ZS/TRAIN", "D/NIV2TEXTTOCODE/ZS/TRAIN", "D/NIV2PARAPHRASING/ZS/TRAIN", "D/NIV2DIALOGUEGENERATION/ZS/TRAIN", "D/NIV2QUESTIONREWRITING/ZS/TRAIN", "D/NIV2WORDSEMANTICS/ZS/TRAIN", "D/NIV2POSTAGGING/ZS/TRAIN", "D/NIV2LINGUISTICPROBING/ZS/TRAIN", "D/NIV2STORYCOMPOSITION/ZS/TRAIN", "D/NIV2SPEAKERIDENTIFICATION/ZS/TRAIN", "D/NIV2WORDANALOGY/ZS/TRAIN", "D/NIV2DATATOTEXT/ZS/TRAIN", "D/NIV2STEREOTYPEDETECTION/ZS/TRAIN", "D/NIV2NEGOTIATIONSTRATEGYDETECTION/ZS/TRAIN", "D/NIV2DIALOGUEACTRECOGNITION/ZS/TRAIN", "D/NIV2GENDERCLASSIFICATION/ZS/TRAIN", "D/NIV2COHERENCECLASSIFICATION/ZS/TRAIN", "D/NIV2EXPLANATION/ZS/TRAIN", "D/NIV2ETHICSCLASSIFICATION/ZS/TRAIN", "D/NIV2WORDRELATIONCLASSIFICATION/ZS/TRAIN", "D/NIV2SENTENCEORDERING/ZS/TRAIN", "D/NIV2ANSWERVERIFICATION/ZS/TRAIN", "D/NIV2MATHEMATICS/ZS/TRAIN", "D/NIV2INTENTIDENTIFICATION/ZS/TRAIN", "D/NIV2KEYWORDTAGGING/ZS/TRAIN", "D/NIV2CODETOTEXT/ZS/TRAIN", "D/NIV2DIALOGUESTATETRACKING/ZS/TRAIN", "D/NIV2TEXTSIMPLIFICATION/ZS/TRAIN", "D/NIV2STANCEDETECTION/ZS/TRAIN", "D/NIV2FACTVERIFICATION/ZS/TRAIN", "D/NIV2GRAMMARERRORDETECTION/ZS/TRAIN", "D/NIV2SECTIONCLASSIFICATION/ZS/TRAIN", "D/NIV2NUMBERCONVERSION/ZS/TRAIN", "D/NIV2STYLETRANSFER/ZS/TRAIN", "D/NIV2SPEAKERRELATIONCLASSIFICATION/ZS/TRAIN", "D/NIV2IRONYDETECTION/ZS/TRAIN", "D/NIV2QUESTIONDECOMPOSITION/ZS/TRAIN", "D/NIV2OVERLAPEXTRACTION/ZS/TRAIN", "D/NIV2GRAMMARERRORCORRECTION/ZS/TRAIN", "D/NIV2SPELLINGERRORDETECTION/ZS/TRAIN", "D/NIV2ENTITYGENERATION/ZS/TRAIN", "D/NIV2SENTENCEEXPANSION/ZS/TRAIN", "D/NIV2DISCOURSECONNECTIVEIDENTIFICATION/ZS/TRAIN", "D/NIV2DISCOURSERELATIONCLASSIFICATION/ZS/TRAIN", "D/NIV2POEMGENERATION/ZS/TRAIN", "D/NIV2ENTITYRELATIONCLASSIFICATION/ZS/TRAIN", "D/NIV2PUNCTUATIONERRORDETECTION/ZS/TRAIN", "D/NIV2SPAMCLASSIFICATION/ZS/TRAIN", "D/NIV2PAPERREVIEW/ZS/TRAIN", "D/NIV2SENTENCECOMPRESSION/ZS/TRAIN", "D/NIV2PREPOSITIONPREDICTION/ZS/TRAIN", "D/NIV2MISC/ZS/TRAIN"]'

elif [[ "$DATASET_SETTING" == "Add1" ]]; then
    echo -e "Using Add1 dataset setting\n"
    DATASET_BINDING='P/RETRIEVE/Retriever.datasets=["D/P3WSCFIXED/TRAIN", "D/P3COPA/TRAIN", "D/P3HSWAG/TRAIN", "D/P3WIC/TRAIN", "D/P3RACEHIGH/TRAIN", "D/P3RACEMIDDLE/TRAIN", "D/P3WEBQUESTIONS/TRAIN", "D/DIALOGQRECC/ZS/TRAIN", "D/DIALOGWIKIDIALOG/ZS/TRAIN", "D/DIALOGQRECCII/ZS/TRAIN", "D/DIALOGWIKIDIALOGII/ZS/TRAIN", "D/FLAN2021AESLC/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATECSEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATEDEEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATERUEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATEFIEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATEROEN/ZS/TRAIN", "D/FLAN2021WMT16TRANSLATETREN/ZS/TRAIN", "D/FLAN2021WMT14TRANSLATEFREN/ZS/TRAIN"]'

elif [[ "$DATASET_SETTING" == "All" ]]; then
    echo -e "Using All dataset setting\n"
    FROM_CHECKPOINT_PATH="AllCompleteA2_t5xl_lora_concatenated"
    if [[ "$INCLUDE_ANSWER_CHOICES" == "True" ]]; then
        TO_CHECKPOINT_PATH="AllCompleteansretrieval_t5xl_lora_concatenated"
    else
        TO_CHECKPOINT_PATH="AllCompleteretrieval_t5xl_lora_concatenated"
    fi

elif [[ "$DATASET_SETTING" == "Full" ]]; then
    echo -e "Using Full dataset setting\n"
    FROM_CHECKPOINT_PATH="FullCompleteA2_t5xl_lora_concatenated"
    if [[ "$INCLUDE_ANSWER_CHOICES" == "True" ]]; then
        TO_CHECKPOINT_PATH="FullCompleteansretrieval_t5xl_lora_concatenated"
    else
        TO_CHECKPOINT_PATH="FullCompleteretrieval_t5xl_lora_concatenated"
    fi
fi

if [[ "${MAKE_EXPERT_LIBRARY}" == "True" ]]; then
    echo -e "\nMaking expert library\n"
    python src/launch_single_process.py --gin_files colm/datasets/p3_${MODEL_TYPE}.gin colm/datasets/flanv2_${MODEL_TYPE}.gin colm/experiments/retriever.gin --gin_bindings ${ANSWER_CHOICES_BINDING} ${EXP_LIB_DIR_BINDING} P/RETRIEVE/Retriever.dataset_length=1000 ${DATASET_BINDING} ${EXTRA_BINDINGS}
elif [[ "${CREATE_CHECKPOINT}" == "True" ]]; then
    echo -e "\nCreating retriever checkpoint\n"
    python scripts/manipulations.py --gin_bindings make_checkpoint_for_retrieval.checkpoint_path=\"${FROM_CHECKPOINT_PATH}\" make_checkpoint_for_retrieval.embeddings_path=\"${READ_DIR}\" make_checkpoint_for_retrieval.out_path=\"${TO_CHECKPOINT_PATH}\" 'func_caller.func=@make_checkpoint_for_retrieval' make_checkpoint_for_retrieval.dataset_length=1000 make_checkpoint_for_retrieval.dataset_dict_str=\"${DATASET_SETTING}\"
else
    echo -e "\nEvaluating retriever checkpoint\n"
    echo -e "score_type: ${SCORE_TYPE}, scaling_scores: ${SCALING_SCORES} elementwise_affine: ${ELEMENTWISE_AFFINE}\n"
    EXP_NAME=${TO_CHECKPOINT_PATH} python src/launch_single_process.py --gin_files colm/datasets/p3_${MODEL_TYPE}.gin colm/datasets/flanv2_${MODEL_TYPE}.gin colm/datasets/bigbench.gin colm/models/${MODEL_TYPE}/t5.gin colm/models/${MODEL_TYPE}/moe_lora_retriever.gin  colm/experiments/eval.gin --gin_bindings 'main.procedure_exec_order=["P/EVALUATE/BBH", "P/EVALUATE/HELDOUT"]' 'M/MODEL/Model.init_moma_calls = [@M/MODEL/insert_feature_extractor, @M/MODEL/ENCODER/make_moe, @M/MODEL/DECODER/make_moe, @M/MODEL/load_weights]' M/MODEL/load_weights.weight_path=\"exp_out/${TO_CHECKPOINT_PATH}/best.pt\" 'M/MODEL/Model.pass_batch_input=True' 'M/MODEL/Router.is_retriever=True' M/MODEL/FeatureExtractor.include_answer_choices=\"${INCLUDE_ANSWER_CHOICES}\" ${EXTRA_BINDINGS}
fi
