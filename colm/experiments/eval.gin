import src.models
import src.procedures
import src.procedures.utils
import src.models.addons
import src.models.manipulations
import src.utils.logging

P/EVALUATE/build.cls = @Evaluator
P/EVALUATE/Evaluator:
    model = "M/MODEL"
    datasets = "D/${DATASET}/EVAL"
    save_results = @save_results
    analysis_processors = []

P/EVALUATE/HELDIN/Evaluator:
    datasets = ["D/P3AGNEWS/EVAL", "D/P3AMAZONPOLARITY/EVAL", "D/P3COSMOSQA/EVAL", "D/P3SAMSUM/EVAL", "D/P3QUARTZ/EVAL", "D/P3ROPES/EVAL", "D/P3WIKIBIO/EVAL", "D/P3PAWS/EVAL", "D/P3WIKIQA/EVAL", "D/P3SOCIALIQA/EVAL", "D/P3QASC/EVAL", "D/P3QUAIL/EVAL", "D/P3DREAM/EVAL", "D/P3WIQA/EVAL", "D/P3QUAREL/EVAL", "D/P3SCIQ/EVAL", "D/P3QUOREF/EVAL", "D/P3DUORC/EVAL", "D/P3ROTTENTOMATOES/EVAL", "D/P3YELP/EVAL", "D/P3COMMONGEN/EVAL", "D/P3GIGAWORD/EVAL", "D/P3XSUM/EVAL", "D/P3MRPC/EVAL", "D/P3QQP/EVAL", "D/P3COMMONSENSEQA/EVAL", "D/P3COSE/EVAL", "D/P3WIKIHOP/EVAL", "D/P3HOTPOTQA/EVAL", "D/P3APPREVIEWS/EVAL", "D/P3TREC/EVAL", "D/P3MULTINEWS/EVAL", "D/P3IMDB/EVAL", "D/P3ADVERSARIALQA/EVAL", "D/P3CNNDAILYMAIL/EVAL", "D/P3DBPEDIA14/EVAL"]

P/EVALUATE/HELDOUT/Evaluator:
    datasets = ["D/P3RTE/EVAL", "D/P3HSWAG/EVAL", "D/P3COPA/EVAL", "D/P3WIC/EVAL", "D/P3WINOGRANDE/EVAL", "D/P3CB/EVAL", "D/P3STORYCLOZE/EVAL", "D/P3ANLI/R1/EVAL", "D/P3ANLI/R2/EVAL", "D/P3ANLI/R3/EVAL", "D/P3WSCFIXED/EVAL"]
P/EVALUATE/BBH/Evaluator:
    datasets = ["D/BBBOOLEANEXPRESSIONS/EVAL", "D/BBCAUSALJUDGEMENT/EVAL", "D/BBDATEUNDERSTANDING/EVAL", "D/BBDISAMBIGUATIONQA/EVAL", "D/BBFORMALFALLACIES/EVAL", "D/BBGEOMETRICSHAPES/EVAL", "D/BBHYPERBATON/EVAL", "D/BBLOGICALDEDUCTION/EVAL", "D/BBMOVIERECOMMENDATION/EVAL", "D/BBMULTISTEPARITHMETICTWO/EVAL", "D/BBNAVIGATE/EVAL", "D/BBOBJECTCOUNTING/EVAL", "D/BBPENGUINSINATABLE/EVAL", "D/BBREASONINGABOUTCOLOREDOBJECTS/EVAL", "D/BBRUINNAMES/EVAL", "D/BBSALIENTTRANSLATIONERRORDETECTION/EVAL", "D/BBSNARKS/EVAL", "D/BBSPORTSUNDERSTANDING/EVAL", "D/BBTEMPORALSEQUENCES/EVAL", "D/BBTRACKINGSHUFFLEDOBJECTS/EVAL", "D/BBWEBOFLIES/EVAL", "D/BBWORDSORTING/EVAL"]
P/EVALUATE/BBLITE/Evaluator:
    datasets = ["D/BBBBQLITEJSON/EVAL", "D/BBCONCEPTUALCOMBINATIONS/EVAL", "D/BBCONLANGTRANSLATION/EVAL", "D/BBFORMALFALLACIES/EVAL", "D/BBHINDUKNOWLEDGE/EVAL", "D/BBKNOWNUNKNOWNS/EVAL", "D/BBLINGUISTICSPUZZLES/EVAL", "D/BBLOGICGRIDPUZZLE/EVAL", "D/BBLOGICALDEDUCTION/EVAL", "D/BBNOVELCONCEPTS/EVAL", "D/BBOPERATORS/EVAL", "D/BBPLAYDIALOGSAMEORDIFFERENT/EVAL", "D/BBREPEATCOPYLOGIC/EVAL", "D/BBSTRANGESTORIES/EVAL", "D/BBSTRATEGYQA/EVAL", "D/BBVITAMINCFACTVERIFICATION/EVAL", "D/BBWINOWHY/EVAL"]

save_results.save_dir = "exp_out/${EXP_NAME}"
P/EVALUATE/save_results.overwrite = True
P/EVALUATE/HELDOUT/save_results.overwrite = False
RoutingDistribution.save_dir = "exp_out/${EXP_NAME}/routing_distribution"
EntropyDistribution.save_dir = "exp_out/${EXP_NAME}/entropy_distribution"

M/MODEL/Model.trainable_params = "none"
M/MODEL/load_weights.weight_path = "exp_out/${EXP_NAME}/best.pt"
M/MODEL/Model.init_moma_calls = [@M/MODEL/ENCODER/watch_hiddens, @M/MODEL/DECODER/watch_hiddens, @M/MODEL/ENCODER/make_moe, @M/MODEL/DECODER/make_moe, @M/MODEL/load_weights]

M/MODEL/ExtendableAddon.separate_experts = True

main:
    procedure_exec_order=["P/EVALUATE"]
    exp_name="${EXP_NAME}"
    global_seed = 42
